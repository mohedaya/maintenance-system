<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maintenance Dashboard</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.section { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; }
.task { margin-left: 20px; }
input[type="number"] { width: 70px; margin-left: 10px; }
button { padding: 6px 12px; }
</style>
</head>

<body>

<h1>Maintenance Dashboard</h1>

<div class="section">
  <label><strong>Select Inspection:</strong></label>
  <select id="inspectionSelect"></select>
  <button id="loadBtn">Load Work Package</button>
</div>

<div class="section">
  <h3>Tasks</h3>
  <div id="tasks">No tasks loaded</div>
</div>

<div class="section">
  <strong>Total Man-Hours:</strong>
  <span id="totalMH">0.0</span>
</div>

<script>
let libraryData = null;

/* ===== LOAD LIBRARY ===== */
fetch("./library/inspection_library.json")
  .then(res => {
    if (!res.ok) throw new Error("Library fetch failed");
    return res.json();
  })
  .then(data => {
    libraryData = data;
    const select = document.getElementById("inspectionSelect");
    Object.keys(data.inspections).forEach(key => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = key;
      select.appendChild(opt);
    });
  })
  .catch(err => alert(err.message));

/* ===== BUTTON ===== */
document.getElementById("loadBtn").addEventListener("click", () => {
  const insp = document.getElementById("inspectionSelect").value;
  renderTasks(insp);
});

/* ===== RENDER TASKS (FIXED) ===== */
function renderTasks(inspKey) {
  const container = document.getElementById("tasks");
  container.innerHTML = "";
  document.getElementById("totalMH").textContent = "0.0";

  const inspection = libraryData.inspections[inspKey];
  if (!inspection) {
    container.textContent = "Inspection not found";
    return;
  }

  inspection.sections.forEach(sec => {
    const secDiv = document.createElement("div");
    secDiv.innerHTML = `<h4>${sec.section} (${inspKey})</h4>`;

    sec.tasks.forEach(task => {
      const taskDiv = document.createElement("div");
      taskDiv.className = "task";
      taskDiv.innerHTML = `
        ${task.task_id} - ${task.title}
        <input type="number" min="0" step="0.1" value="0"
               oninput="calculateTotal()">
      `;
      secDiv.appendChild(taskDiv);
    });

    container.appendChild(secDiv);
  });
}

/* ===== TOTAL MH ===== */
function calculateTotal() {
  let sum = 0;
  document.querySelectorAll(".task input").forEach(i => {
    sum += Number(i.value) || 0;
  });
  document.getElementById("totalMH").textContent = sum.toFixed(1);
}
</script>

</body>
</html>
