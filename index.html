<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AW139 Maintenance System</title>
<style>
body{font-family:Arial;margin:20px}
.section{border:1px solid #ccc;padding:10px;margin-bottom:15px}
.task{margin-left:20px}
.nr{margin-left:40px;color:#b00000}
input[type=number]{width:70px}
button{margin:4px}
table{border-collapse:collapse;width:100%}
td,th{border:1px solid #ccc;padding:5px}
</style>
</head>
<body>

<h1>AW139 Maintenance Dashboard</h1>

<!-- WORK PACKAGE -->
<div class="section">
<b>Select Inspection(s)</b><br>
<select id="inspSel" multiple size="6"></select><br>
<button onclick="loadWP()">Load Work Package</button>
</div>

<!-- STATS -->
<div class="section">
Overall Progress: <span id="pct">0%</span><br>
Total Man-Hours: <span id="mh">0.0</span>
</div>

<!-- TASKS -->
<div class="section">
<h3>Tasks</h3>
<div id="tasks"></div>
</div>

<!-- NON ROUTINE -->
<div class="section">
<h3>Non-Routine</h3>
NR No <input id="nrNo">
Section <input id="nrSec">
Desc <input id="nrDesc">
MH <input type="number" id="nrMH" step="0.1">
<button onclick="addNR()">Add NR</button>
</div>

<!-- PARTS -->
<div class="section">
<h3>Parts / AOG</h3>
Part No <input id="pno">
Qty <input type="number" id="pqty">
<button onclick="addPart()">Add Part</button>
<table>
<thead><tr><th>P/N</th><th>Qty</th></tr></thead>
<tbody id="parts"></tbody>
</table>
</div>

<!-- HISTORY -->
<div class="section">
<h3>Close Work Package</h3>
<button onclick="closeWP()">Close & Save History</button>
</div>

<!-- REPORT -->
<div class="section">
<h3>Man-Hour Report</h3>
<div id="report"></div>
</div>

<script>
let lib, tasks=[], nr=[], parts=[], history=[];

fetch("./library/inspection_library.json")
.then(r=>r.json())
.then(d=>{
  lib=d;
  Object.keys(d.inspections).forEach(i=>{
    let o=document.createElement("option");
    o.textContent=i; o.value=i;
    inspSel.appendChild(o);
  });
});

function loadWP(){
  tasks=[]; nr=[]; parts=[];
  tasksDiv.innerHTML="";
  [...inspSel.selectedOptions].map(o=>o.value).forEach(i=>{
    lib.inspections[i].sections.forEach(s=>{
      s.tasks.forEach(t=>{
        tasks.push({i,sec:s.section,id:t.task_id,title:t.title,done:false,mh:0});
      });
    });
  });
  render();
}

function render(){
  tasksDiv.innerHTML="";
  let secs=[...new Set(tasks.map(t=>t.sec))];
  secs.forEach(s=>{
    let d=document.createElement("div");
    d.innerHTML=`<h4>${s}</h4>`;
    tasks.filter(t=>t.sec===s).forEach(t=>{
      let x=document.createElement("div");
      x.className="task";
      x.innerHTML=`
      <input type=checkbox onchange="tDone('${t.id}',this.checked)">
      ${t.id} - ${t.title}
      <input type=number step=0.1 onchange="tMH('${t.id}',this.value)">
      `;
      d.appendChild(x);
    });
    nr.filter(n=>n.sec===s).forEach(n=>{
      let x=document.createElement("div");
      x.className="nr";
      x.textContent=`NR ${n.no} ${n.desc} MH ${n.mh}`;
      d.appendChild(x);
    });
    tasksDiv.appendChild(d);
  });
  update();
}

function tDone(id,v){tasks.find(t=>t.id===id).done=v;update();}
function tMH(id,v){tasks.find(t=>t.id===id).mh=+v||0;update();}

function addNR(){
  nr.push({no:nrNo.value,sec:nrSec.value,desc:nrDesc.value,mh:+nrMH.value||0});
  render();
}

function addPart(){
  parts.push({p:pno.value,q:+pqty.value||0});
  let r=document.createElement("tr");
  r.innerHTML=`<td>${pno.value}</td><td>${pqty.value}</td>`;
  partsDiv.appendChild(r);
}

function update(){
  let done=tasks.filter(t=>t.done).length;
  pct.textContent=tasks.length?Math.round(done/tasks.length*100)+"%":"0%";
  let mhv=tasks.reduce((a,b)=>a+b.mh,0)+nr.reduce((a,b)=>a+b.mh,0);
  mh.textContent=mhv.toFixed(1);
  report.innerHTML=`Tasks MH: ${mhv.toFixed(1)}`;
}

function closeWP(){
  history.push({date:new Date(),tasks,nr,parts});
  alert("Work package closed and saved (browser)");
}
</script>

</body>
</html>
